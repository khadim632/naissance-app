const PreDeclarationNaissance = require('../models/PreDeclarationNaissance');
const PreDeclarationDeces = require('../models/PreDeclarationDeces');
const User = require('../models/User');
const sendEmail = require('../utils/sendEmail'); // √† cr√©er

// Naissance
exports.creerPreDeclarationNaissance = async (req, res) => {
  try {
    const data = req.body;
    const user = req.user;

    const mairie = await User.findOne({ nom: data.nomMairie, role: 'mairie' });

    if (!mairie) {
      return res.status(400).json({ message: 'Mairie non trouv√©e avec ce nom' });
    }

    // Cr√©ation de la d√©claration
    const declaration = new PreDeclarationNaissance({
        nomBebe: data.nomBebe,
        prenomBebe: data.prenomBebe,
        sexe: data.sexe, // üÜï Sexe du b√©b√©
        dateNaissance: data.dateNaissance,
        lieuNaissance: data.lieuNaissance,
        heureNaissance: data.heureNaissance,
        pere: data.pere,
        mere: data.mere,
        mairieDestinataire: mairie._id,
  
        // Infos sur l‚Äôh√¥pital
        createdBy: user._id,
        hopitalNom: user.nom,
        hopitalEmail: user.email
      });
  

    await declaration.save();

    // envoi de mail
    const parentEmail = data.pere.email || data.mere.email;
    if (parentEmail) {
      await sendEmail({
        to: parentEmail,
        subject: 'Pr√©-d√©claration de naissance enregistr√©e',
        text: `ID du b√©b√© :la predeclaration de  ${data.prenomBebe} ${data.nomBebe} n√©e le ${data.dateNaissance} a pour ${declaration._id}\nMairie : ${mairie.nom || mairie.email}`
      });
    }

    res.status(201).json(declaration);
  } catch (err) {
    res.status(500).json({ message: 'Erreur serveur', error: err.message });
  }
};

// D√©c√®s
exports.creerPreDeclarationDeces = async (req, res) => {
  try {
    const data = req.body;
    const user = req.user;

    const declaration = new PreDeclarationDeces({
        pere: data.pere,
        mere: data.mere,
        descriptionMort: data.descriptionMort,
        createdBy: user._id,
        hopitalNom: user.nom,         // Optionnel : √† ajouter dans le sch√©ma
        hopitalEmail: user.email      // Optionnel : √† ajouter dans le sch√©ma
      })

    await declaration.save();

    const parentEmail = data.pere.email || data.mere.email;
    if (parentEmail) {
      await sendEmail({
        to: parentEmail,
        subject: 'Pr√©-d√©claration de d√©c√®s infantile enregistr√©e',
        text: `Votre d√©claration a bien √©t√© re√ßue.`
      });
    }

    res.status(201).json(declaration);
  } catch (err) {
    res.status(500).json({ message: 'Erreur serveur', error: err.message });
  }
};

// Afficher toutes les pr√©-d√©clarations de naissance de l'h√¥pital connect√©
exports.getMesPreDeclarationsNaissance = async (req, res) => {
  try {
    
    const declarations = await PreDeclarationNaissance.find({ createdBy: req.user._id }).populate('mairieDestinataire', 'nom email');
    res.json(declarations);
  } catch (err) {
    res.status(500).json({ message: 'Erreur serveur', error: err.message });
  }
};



// Afficher toutes les pr√©-d√©clarations (naissance + d√©c√®s) de l'h√¥pital connect√©
exports.getMesPreDeclarations = async (req, res) => {
  try {
    const [naissances, deces] = await Promise.all([
      PreDeclarationNaissance.find({ createdBy: req.user._id }).populate('mairieDestinataire', 'nom email'),
      PreDeclarationDeces.find({ createdBy: req.user._id })
    ]);
    res.json({ naissances, deces });
  } catch (err) {
    res.status(500).json({ message: 'Erreur serveur', error: err.message });
  }
};

exports.modifierPreDeclaration = async (req, res) => {
  try {
    const userId = req.user._id;
    const preDeclarationId = req.params.id;

    // On cherche la pr√©-d√©claration par ID et on s'assure que c'est bien celle de l'h√¥pital connect√©
    const preDeclaration = await PreDeclarationNaissance.findOne({ _id: preDeclarationId, createdBy: userId });

    if (!preDeclaration) {
      return res.status(404).json({ message: "Pr√©-d√©claration non trouv√©e ou acc√®s refus√©." });
    }

    // Mise √† jour des champs (req.body contient les champs √† modifier)
    Object.assign(preDeclaration, req.body);
    await preDeclaration.save();

    res.json({ message: "Pr√©-d√©claration mise √† jour avec succ√®s.", data: preDeclaration });

  } catch (err) {
    res.status(500).json({ message: "Erreur serveur", error: err.message });
  }
};

exports.modifierPreDeclarationNaissance = async (req, res) => {
  try {
    const preDeclarationId = req.params.id;
    let preDeclaration;

    // Si admin/superadmin => acc√®s global
    if (req.user.role === 'admin' || req.user.role === 'superadmin') {
      preDeclaration = await PreDeclarationNaissance.findById(preDeclarationId);
    } else {
      preDeclaration = await PreDeclarationNaissance.findOne({
        _id: preDeclarationId,
        createdBy: req.user._id
      });
    }

    if (!preDeclaration) {
      return res.status(404).json({ message: "Pr√©-d√©claration non trouv√©e ou acc√®s refus√©." });
    }

    Object.assign(preDeclaration, req.body);
    await preDeclaration.save();

    res.json({ message: "Pr√©-d√©claration de naissance modifi√©e avec succ√®s.", data: preDeclaration });

  } catch (err) {
    res.status(500).json({ message: "Erreur serveur", error: err.message });
  }
};


exports.modifierPreDeclarationDeces = async (req, res) => {
  try {
    const userId = req.user._id;
    const preDeclarationId = req.params.id;

    const preDeclaration = await PreDeclarationDeces.findOne({
      _id: preDeclarationId,
      createdBy: userId
    });

    if (!preDeclaration) {
      return res.status(404).json({ message: "Pr√©-d√©claration de d√©c√®s non trouv√©e ou acc√®s refus√©." });
    }

    Object.assign(preDeclaration, req.body);
    await preDeclaration.save();

    res.json({ message: "Pr√©-d√©claration de d√©c√®s modifi√©e avec succ√®s.", data: preDeclaration });

  } catch (err) {
    res.status(500).json({ message: "Erreur serveur", error: err.message });
  }
};

exports.supprimerPreDeclarationNaissance = async (req, res) => {
  try {
    const preDeclarationId = req.params.id;
    let preDeclaration;

    if (req.user.role === 'admin' || req.user.role === 'superadmin') {
      preDeclaration = await PreDeclarationNaissance.findByIdAndDelete(preDeclarationId);
    } else {
      preDeclaration = await PreDeclarationNaissance.findOneAndDelete({
        _id: preDeclarationId,
        createdBy: req.user._id
      });
    }

    if (!preDeclaration) {
      return res.status(404).json({ message: "Pr√©-d√©claration de naissance non trouv√©e ou acc√®s refus√©." });
    }

    res.json({ message: "Pr√©-d√©claration de naissance supprim√©e avec succ√®s." });

  } catch (err) {
    res.status(500).json({ message: "Erreur serveur", error: err.message });
  }
};


exports.supprimerPreDeclarationDeces = async (req, res) => {
  try {
    const userId = req.user._id;
    const preDeclarationId = req.params.id;

    const preDeclaration = await PreDeclarationDeces.findOneAndDelete({
      _id: preDeclarationId,
      createdBy: userId
    });

    if (!preDeclaration) {
      return res.status(404).json({ message: "Pr√©-d√©claration de d√©c√®s non trouv√©e ou acc√®s refus√©." });
    }

    res.json({ message: "Pr√©-d√©claration de d√©c√®s supprim√©e avec succ√®s." });

  } catch (err) {
    res.status(500).json({ message: "Erreur serveur", error: err.message });
  }
};

exports.getPreDeclarationNaissanceById = async (req, res) => {
  try {
    const preDeclaration = await PreDeclarationNaissance.findById(req.params.id)
      .populate('mairieDestinataire', 'nom email');

    if (!preDeclaration) {
      return res.status(404).json({ message: "Pr√©-d√©claration de naissance non trouv√©e." });
    }

    // Acc√®s : admin/superadmin ou cr√©ateur
    if (
      req.user.role !== 'admin' &&
      req.user.role !== 'superadmin' &&
      String(preDeclaration.createdBy) !== String(req.user._id)
    ) {
      return res.status(403).json({ message: "Acc√®s refus√©." });
    }

    res.json(preDeclaration);
  } catch (err) {
    res.status(500).json({ message: "Erreur serveur", error: err.message });
  }
};

exports.getPreDeclarationDecesById = async (req, res) => {
  try {
    const preDeclaration = await PreDeclarationDeces.findById(req.params.id);

    if (!preDeclaration) {
      return res.status(404).json({ message: "Pr√©-d√©claration de d√©c√®s non trouv√©e." });
    }

    // Acc√®s : admin/superadmin ou cr√©ateur
    if (
      req.user.role !== 'admin' &&
      req.user.role !== 'superadmin' &&
      String(preDeclaration.createdBy) !== String(req.user._id)
    ) {
      return res.status(403).json({ message: "Acc√®s refus√©." });
    }

    res.json(preDeclaration);
  } catch (err) {
    res.status(500).json({ message: "Erreur serveur", error: err.message });
  }
};

exports.getStatistiquesParHopital = async (req, res) => {
  try {
    const userId = req.user._id;

    const [nbNaissances, nbDeces] = await Promise.all([
      PreDeclarationNaissance.countDocuments({ createdBy: userId }),
      PreDeclarationDeces.countDocuments({ createdBy: userId })
    ]);

    res.json({
        hopital: req.user.nom || req.user.email,
        nbNaissances,
        nbDeces,
        total: nbNaissances + nbDeces
});
  } catch (err) {
    res.status(500).json({ message: "Erreur serveur", error: err.message });
  }
};

// Corriger la fonction getStatistiquesGlobales
exports.getStatistiquesGlobales = async (req, res) => {
  try {
    if (req.user.role !== 'admin' && req.user.role !== 'superadmin') {
      return res.status(403).json({ message: "Acc√®s refus√©." });
    }

    const [nbNaissances, nbDeces] = await Promise.all([
      PreDeclarationNaissance.countDocuments(),
      PreDeclarationDeces.countDocuments()
    ]);

    res.json({
      totalNaissances: nbNaissances,
      totalDeces: nbDeces,
      total: nbNaissances + nbDeces, // Correction: utiliser les bonnes variables
    });
  } catch (err) {
    res.status(500).json({ message: "Erreur serveur", error: err.message });
  }
};

// Corriger la fonction getStatistiquesMairie pour √™tre coh√©rente
exports.getStatistiquesMairie = async (req, res) => {
  try {
    if (req.user.role !== 'mairie') {
      return res.status(403).json({ message: "Acc√®s r√©serv√© aux mairies." });
    }

    const mongoose = require('mongoose'); // Ajouter cet import si pas d√©j√† fait

    const stats = await PreDeclarationNaissance.aggregate([
      { $match: { mairieDestinataire: mongoose.Types.ObjectId(req.user._id) } },
      { $group: {
          _id: "$statutValidation",
          count: { $sum: 1 }
        }
      }
    ]);

    // Transformer le r√©sultat en format plus lisible
    const statistiques = {
      total: 0,
      enAttente: 0,
      validees: 0,
      refusees: 0
    };

    stats.forEach(stat => {
      if (stat._id === 'en attente') statistiques.enAttente = stat.count;
      else if (stat._id === 'valid√©e') statistiques.validees = stat.count;
      else if (stat._id === 'refus√©e') statistiques.refusees = stat.count;
      statistiques.total += stat.count;
    });

    res.json({
      mairie: req.user.nom || req.user.email,
      statistiques
    });

  } catch (err) {
    res.status(500).json({ message: "Erreur serveur", error: err.message });
  }
};

// Ajouter une nouvelle fonction pour les statistiques de validation globales (optionnel)
exports.getStatistiquesValidationGlobales = async (req, res) => {
  try {
    if (req.user.role !== 'admin' && req.user.role !== 'superadmin') {
      return res.status(403).json({ message: "Acc√®s refus√©." });
    }

    const stats = await PreDeclarationNaissance.aggregate([
      { $group: {
          _id: "$statutValidation",
          count: { $sum: 1 }
        }
      }
    ]);

    const statistiques = {
      total: 0,
      enAttente: 0,
      validees: 0,
      refusees: 0
    };

    stats.forEach(stat => {
      if (stat._id === 'en attente' || !stat._id) statistiques.enAttente = stat.count;
      else if (stat._id === 'valid√©e') statistiques.validees = stat.count;
      else if (stat._id === 'refus√©e') statistiques.refusees = stat.count;
      statistiques.total += stat.count;
    });

    res.json(statistiques);

  } catch (err) {
    res.status(500).json({ message: "Erreur serveur", error: err.message });
  }
};
exports.getStatistiquesParHopitalPourAdmin = async (req, res) => {
  try {
    if (req.user.role !== 'admin' && req.user.role !== 'superadmin') {
      return res.status(403).json({ message: "Acc√®s refus√©." });
    }

    const statsNaissance = await PreDeclarationNaissance.aggregate([
      { $group: { _id: "$createdBy", totalNaissances: { $sum: 1 } } }
    ]);

    const statsDeces = await PreDeclarationDeces.aggregate([
      { $group: { _id: "$createdBy", totalDeces: { $sum: 1 } } }
    ]);

    // Fusionner les deux tableaux par _id (createdBy)
    const mergedStats = {};

    statsNaissance.forEach(stat => {
      mergedStats[stat._id] = { createdBy: stat._id, totalNaissances: stat.totalNaissances, totalDeces: 0 };
    });

    statsDeces.forEach(stat => {
      if (!mergedStats[stat._id]) {
        mergedStats[stat._id] = { createdBy: stat._id, totalNaissances: 0, totalDeces: stat.totalDeces };
      } else {
        mergedStats[stat._id].totalDeces = stat.totalDeces;
      }
    });

    // R√©cup√©rer les infos de l'utilisateur (nom, email) avec populate
    const results = await Promise.all(Object.values(mergedStats).map(async (stat) => {
      const user = await User.findById(stat.createdBy);
      return {
        hopital: user?.nom || user?.email,
        totalNaissances: stat.totalNaissances,
        totalDeces: stat.totalDeces
      };
    }));

    res.json(results);

  } catch (err) {
    res.status(500).json({ message: "Erreur serveur", error: err.message¬†});
¬†¬†}
};

exports.afficherToutesLesPreDeclarations = async (req, res) => {
  try {
    const naissances = await PreDeclarationNaissance.find()
      .populate('mairieDestinataire', 'nom email') // afficher nom/email de la mairie
      .populate('createdBy', 'nom email role');     // afficher nom/email/role de celui qui a cr√©√©

    const deces = await PreDeclarationDeces.find()
      .populate('createdBy', 'nom email role');

    res.status(200).json({
      naissances,
      deces
    });
  } catch (err) {
    res.status(500).json({ message: 'Erreur serveur', error: err.message });
  }
};

// Afficher les pr√©-d√©clarations re√ßues par une mairie connect√©e
exports.listerPredeclarationsMairie = async (req, res) => {
  try {
    if (req.user.role !== 'mairie') {
      return res.status(403).json({ message: 'Acc√®s non autoris√©' });
    }

    const declarations = await PreDeclarationNaissance.find({
      mairieDestinataire: req.user._id
    }).populate('createdBy', 'nom email');

    res.status(200).json(declarations);
  } catch (err) {
    res.status(500).json({ message: 'Erreur serveur', erreur: err.message });
  }
};
// Afficher toutes les pr√©-d√©clarations de d√©c√®s de l'h√¥pital connect√©
exports.getMesPreDeclarationsDeces = async (req, res) => {
  try {
    if (req.user.role !== 'hopital') {
      return res.status(403).json({ message: 'Acc√®s non autoris√©' });
    }
    const declarations = await PreDeclarationDeces.find({ createdBy: req.user._id }).populate('mairieDestinataire', 'nom email');
    res.json(declarations);
  } catch (err) {
    res.status(500).json({ message: 'Erreur serveur', error: err.message });
  }
};

// Fonction pour permettre √† une mairie de valider/refuser une pr√©-d√©claration
exports.validerPreDeclarationNaissance = async (req, res) => {
  try {
    // V√©rifier que l'utilisateur est bien une mairie
    if (req.user.role !== 'mairie') {
      return res.status(403).json({ 
        message: "Seules les mairies peuvent valider les pr√©-d√©clarations." 
      });
    }

    const { id } = req.params;
    const { statutValidation, commentaire } = req.body;

    // V√©rifier que le statut est valide
    if (!['valid√©e', 'refus√©e'].includes(statutValidation)) {
      return res.status(400).json({ 
        message: "Le statut doit √™tre 'valid√©e' ou 'refus√©e'." 
      });
    }

    // Trouver la pr√©-d√©claration
    const preDeclaration = await PreDeclarationNaissance.findById(id);

    if (!preDeclaration) {
      return res.status(404).json({ 
        message: "Pr√©-d√©claration de naissance non trouv√©e." 
      });
    }

    // V√©rifier que la mairie est bien celle assign√©e √† cette pr√©-d√©claration
    if (String(preDeclaration.mairieDestinataire) !== String(req.user._id)) {
      return res.status(403).json({ 
        message: "Cette pr√©-d√©claration n'est pas destin√©e √† votre mairie." 
      });
    }

    // Mettre √† jour le statut
    preDeclaration.statutValidation = statutValidation;
    
    // Ajouter un commentaire si fourni
    if (commentaire) {
      preDeclaration.commentaireValidation = commentaire;
    }

    // Sauvegarder les modifications
    await preDeclaration.save();

    // Notifier l'h√¥pital qui a cr√©√© la pr√©-d√©claration
    if (preDeclaration.hopitalEmail) {
      try {
        await sendEmail({
          to: preDeclaration.hopitalEmail,
          subject: `Pr√©-d√©claration de naissance ${statutValidation}`,
          text: `La pr√©-d√©claration de naissance pour ${preDeclaration.prenomBebe} ${preDeclaration.nomBebe} a √©t√© ${statutValidation} par la mairie.${commentaire ? `\n\nCommentaire: ${commentaire}` : ''}`
        });
      } catch (emailErr) {
        console.error("Erreur lors de l'envoi de l'email:", emailErr);
        // Ne pas bloquer la r√©ponse en cas d'√©chec de l'email
      }
    }

    // Notifier les parents si un email est disponible
    const parentEmail = preDeclaration.pere?.email || preDeclaration.mere?.email;
    if (parentEmail) {
      try {
        await sendEmail({
          to: parentEmail,
          subject: `D√©claration de naissance ${statutValidation}`,
          text: `Votre d√©claration de naissance pour ${preDeclaration.prenomBebe} ${preDeclaration.nomBebe} a √©t√© ${statutValidation} par la mairie.${commentaire ? `\n\nCommentaire: ${commentaire}` : ''}`
        });
      } catch (emailErr) {
        console.error("Erreur lors de l'envoi de l'email:", emailErr);
        // Ne pas bloquer la r√©ponse en cas d'√©chec de l'email
      }
    }

    res.json({ 
      message: `Pr√©-d√©claration ${statutValidation} avec succ√®s.`, 
      data: preDeclaration 
    });

  } catch (err) {
    res.status(500).json({ message: "Erreur serveur", error: err.message });
  }
};

// Obtenir les statistiques des validations pour une mairie
exports.getStatistiquesMairie = async (req, res) => {
  try {
    if (req.user.role !== 'mairie') {
      return res.status(403).json({ message: "Acc√®s r√©serv√© aux mairies." });
    }

    const stats = await PreDeclarationNaissance.aggregate([
      { $match: { mairieDestinataire: mongoose.Types.ObjectId(req.user._id) } },
      { $group: {
          _id: "$statutValidation",
          count: { $sum: 1 }
        }
      }
    ]);

    // Transformer le r√©sultat en format plus lisible
    const statistiques = {
      total: 0,
      enAttente: 0,
      validees: 0,
      refusees: 0
    };

    stats.forEach(stat => {
      if (stat._id === 'en attente') statistiques.enAttente = stat.count;
      else if (stat._id === 'valid√©e') statistiques.validees = stat.count;
      else if (stat._id === 'refus√©e') statistiques.refusees = stat.count;
      statistiques.total += stat.count;
    });

    res.json({
      mairie: req.user.nom || req.user.email,
      statistiques
    });

  } catch (err) {
    res.status(500).json({ message: "Erreur serveur", error: err.message });
  }
};